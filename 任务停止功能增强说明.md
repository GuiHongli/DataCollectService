# 任务停止功能增强说明

## 功能概述

为了满足用户需求，我们增强了采集任务的停止功能。现在当用户点击停止按钮时，系统不仅会更新任务状态，还会将停止消息发送到正在执行的用例对应的执行机上的CaseExecuteService服务，让服务内部停止对应taskId的进程。

## 功能特性

### 1. 完整的停止流程
- **任务状态更新**: 将采集任务状态更新为STOPPED
- **执行例次状态更新**: 将所有RUNNING状态的用例执行例次更新为STOPPED
- **远程进程终止**: 调用CaseExecuteService取消正在执行的任务，终止相关进程

### 2. 跨服务通信
- **HTTP调用**: DataCollectService通过HTTP调用CaseExecuteService的取消任务接口
- **错误处理**: 对网络调用异常进行妥善处理，不影响主流程
- **日志记录**: 详细记录每个步骤的执行情况和结果

### 3. 进程管理
- **进程终止**: CaseExecuteService能够强制终止正在执行的Python脚本进程
- **子进程清理**: 确保所有相关的子进程都被正确终止
- **资源释放**: 避免僵尸进程和资源泄漏

## 技术实现

### 1. DataCollectService端

#### 1.1 CaseExecuteServiceClient
```java
@Service
public class CaseExecuteServiceClient {
    
    @Autowired
    private RestTemplate restTemplate;
    
    public boolean cancelTaskExecution(String executorIp, String taskId) {
        String url = String.format("http://%s:8081/test-case-execution/cancel/%s", executorIp, taskId);
        // 调用CaseExecuteService的取消任务接口
    }
}
```

#### 1.2 CollectTaskController增强
```java
@PostMapping("/{id}/stop")
public Result<Boolean> stopTask(@PathVariable @NotNull Long id) {
    // 1. 更新任务状态
    collectTaskService.updateTaskStatus(id, "STOPPED");
    
    // 2. 获取正在执行的用例例次
    List<TestCaseExecutionInstance> runningInstances = 
        testCaseExecutionInstanceService.getByCollectTaskIdAndStatus(id, "RUNNING");
    
    // 3. 调用CaseExecuteService取消任务
    for (TestCaseExecutionInstance instance : runningInstances) {
        if (instance.getExecutionTaskId() != null && instance.getExecutorIp() != null) {
            caseExecuteServiceClient.cancelTaskExecution(instance.getExecutorIp(), instance.getExecutionTaskId());
        }
        // 4. 更新例次状态
        testCaseExecutionInstanceService.updateExecutionStatus(instance.getId(), "STOPPED", null);
    }
}
```

#### 1.3 RestTemplate配置
```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        SimpleClientHttpRequestFactory factory = new SimpleClientHttpRequestFactory();
        factory.setConnectTimeout(10000); // 连接超时10秒
        factory.setReadTimeout(30000);    // 读取超时30秒
        return new RestTemplate(factory);
    }
}
```

### 2. CaseExecuteService端

#### 2.1 任务管理
```java
@Service
public class TestCaseExecutionServiceImpl implements TestCaseExecutionService {
    
    // 存储正在执行的任务和进程信息
    private final Map<String, TaskExecutionInfo> runningTasks = new ConcurrentHashMap<>();
    
    private static class TaskExecutionInfo {
        private final String taskId;
        private final List<Process> processes;
        private final CompletableFuture<Void> executionFuture;
        
        public void cancelAllProcesses() {
            // 终止所有相关进程
        }
        
        public void cancelExecution() {
            // 取消执行Future
        }
    }
}
```

#### 2.2 取消任务接口
```java
@PostMapping("/cancel/{taskId}")
public Result<Map<String, Object>> cancelTask(@PathVariable String taskId) {
    boolean cancelled = testCaseExecutionService.cancelTaskExecution(taskId);
    
    if (cancelled) {
        return Result.success("任务取消成功", result);
    } else {
        return Result.error("任务不存在或已完成");
    }
}
```

#### 2.3 进程终止实现
```java
@Override
public boolean cancelTaskExecution(String taskId) {
    TaskExecutionInfo taskInfo = runningTasks.get(taskId);
    if (taskInfo == null) {
        return false;
    }
    
    try {
        // 1. 取消所有相关进程
        taskInfo.cancelAllProcesses();
        
        // 2. 取消执行Future
        taskInfo.cancelExecution();
        
        // 3. 从运行任务列表中移除
        runningTasks.remove(taskId);
        
        return true;
    } catch (Exception e) {
        log.error("取消任务失败 - 任务ID: {}, 错误: {}", taskId, e.getMessage());
        return false;
    }
}
```

## 执行流程

### 1. 用户操作
1. 用户在任务列表页面点击"停止"按钮
2. 前端调用`POST /api/collect-task/{id}/stop`接口

### 2. DataCollectService处理
1. 验证任务是否存在
2. 更新任务状态为STOPPED
3. 查询所有RUNNING状态的用例执行例次
4. 对每个正在执行的例次：
   - 调用CaseExecuteService取消任务
   - 更新例次状态为STOPPED
5. 返回停止结果

### 3. CaseExecuteService处理
1. 接收取消任务请求
2. 查找对应的任务执行信息
3. 终止所有相关的Python脚本进程
4. 取消执行Future
5. 从运行任务列表中移除
6. 返回取消结果

### 4. 进程终止
1. 调用进程的destroy()方法
2. 等待5秒，如果进程仍在运行则调用destroyForcibly()
3. 记录终止过程和结果

## 错误处理

### 1. 网络异常处理
- 如果无法连接到CaseExecuteService，记录错误但不影响主流程
- 继续更新本地状态，确保任务能够正确停止

### 2. 进程终止异常
- 如果进程终止失败，记录错误信息
- 尝试多种终止方式，确保进程最终被终止

### 3. 状态不一致处理
- 如果任务不存在或已完成，返回相应的错误信息
- 确保系统状态的一致性

## 配置要求

### 1. 网络配置
- DataCollectService需要能够访问CaseExecuteService
- CaseExecuteService默认端口：8081
- 确保防火墙允许相关端口的通信

### 2. 超时配置
- RestTemplate连接超时：10秒
- RestTemplate读取超时：30秒
- 进程终止等待时间：5秒

### 3. 日志配置
- 启用DEBUG级别日志以查看详细的执行过程
- 记录所有网络调用和进程操作

## 测试验证

### 1. 功能测试
1. 创建一个正在执行的任务
2. 点击停止按钮
3. 验证任务状态是否正确更新
4. 验证相关进程是否被终止

### 2. 异常测试
1. 测试网络断开的情况
2. 测试CaseExecuteService不可用的情况
3. 测试进程无法终止的情况

### 3. 性能测试
1. 测试同时停止多个任务的情况
2. 测试大量进程同时终止的情况

## 监控和日志

### 1. 关键日志点
- 任务停止请求接收
- CaseExecuteService调用开始和结果
- 进程终止过程和结果
- 状态更新结果

### 2. 监控指标
- 停止任务的成功率
- 网络调用的响应时间
- 进程终止的成功率
- 异常发生的频率

## 总结

通过这次功能增强，我们实现了：

1. **完整的停止流程**: 从用户操作到进程终止的完整链路
2. **跨服务通信**: DataCollectService和CaseExecuteService之间的协作
3. **进程管理**: 确保正在执行的进程能够被正确终止
4. **错误处理**: 对各种异常情况进行妥善处理
5. **日志记录**: 详细记录执行过程，便于问题排查

这个功能确保了用户能够有效地控制任务的执行，避免资源浪费，提高了系统的可控性和稳定性。
