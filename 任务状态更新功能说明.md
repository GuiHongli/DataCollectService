# 任务状态更新功能说明

## 概述

DataCollectService提供了完整的任务状态管理功能，包括状态更新、状态转换验证、以及相关的用例执行例次状态联动更新。

## 功能特性

### 1. 任务状态定义

#### 任务状态 (status)
- **PENDING**: 待执行
- **RUNNING**: 运行中
- **COMPLETED**: 已完成
- **STOPPED**: 已停止
- **PAUSED**: 已暂停

### 2. 状态转换规则

#### 有效的状态转换
```
PENDING → RUNNING     (启动任务)
PENDING → STOPPED     (停止待执行任务)
RUNNING → COMPLETED   (任务完成)
RUNNING → STOPPED     (停止运行中任务)
RUNNING → PAUSED      (暂停运行中任务)
PAUSED → RUNNING      (恢复暂停任务)
PAUSED → STOPPED      (停止暂停任务)
STOPPED → PENDING     (重置停止任务)
STOPPED → RUNNING     (重新启动停止任务)
```

#### 无效的状态转换
- **COMPLETED → 任何状态**: 已完成状态不能转换到其他状态
- **其他未定义的状态转换**: 系统会拒绝无效的状态转换

### 3. 状态更新接口

#### 3.1 通用状态更新接口
```http
PUT /collect-task/{id}/status?status={newStatus}
```

**参数说明：**
- `id`: 任务ID
- `status`: 新状态 (PENDING/RUNNING/COMPLETED/STOPPED/PAUSED)

**响应示例：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": true,
  "timestamp": 1704067200000
}
```

#### 3.2 快捷操作接口
```http
POST /collect-task/{id}/start    # 启动任务
POST /collect-task/{id}/stop     # 停止任务
POST /collect-task/{id}/pause    # 暂停任务
```

### 4. 状态联动更新

#### 4.1 任务状态更新
当任务状态发生变化时，系统会自动更新以下字段：
- `status`: 任务状态
- `update_time`: 更新时间
- `start_time`: 开始时间（当状态变为RUNNING时）
- `end_time`: 结束时间（当状态变为COMPLETED/STOPPED/PAUSED时）

#### 4.2 用例执行例次状态联动
根据任务状态转换，系统会自动更新相关的用例执行例次状态：

| 任务状态转换 | 例次状态更新 |
|-------------|-------------|
| PENDING → RUNNING | PENDING → RUNNING |
| RUNNING → STOPPED | RUNNING → STOPPED |
| RUNNING → PAUSED | RUNNING → PAUSED |
| PAUSED → RUNNING | PAUSED → RUNNING |
| STOPPED → PENDING | STOPPED → PENDING |
| STOPPED → RUNNING | STOPPED → RUNNING |

### 5. 状态验证机制

#### 5.1 状态值验证
- 验证状态值是否为预定义的有效状态
- 拒绝空值或无效的状态值

#### 5.2 状态转换验证
- 验证状态转换是否符合预定义的转换规则
- 拒绝无效的状态转换请求

### 6. 错误处理

#### 6.1 常见错误
- **任务不存在**: 指定的任务ID不存在
- **无效状态**: 提供的状态值无效
- **无效转换**: 请求的状态转换不符合规则
- **更新失败**: 数据库更新操作失败

#### 6.2 错误响应示例
```json
{
  "code": 400,
  "message": "无效的状态转换: COMPLETED -> RUNNING",
  "data": null,
  "timestamp": 1704067200000
}
```

### 7. 日志记录

系统会记录详细的状态更新日志：
- 状态更新请求
- 状态转换验证结果
- 数据库更新操作结果
- 用例执行例次状态联动更新
- 错误信息和异常堆栈

### 8. 使用示例

#### 8.1 启动任务
```bash
curl -X PUT "http://localhost:8080/collect-task/46/status?status=RUNNING"
```

#### 8.2 停止任务
```bash
curl -X PUT "http://localhost:8080/collect-task/46/status?status=STOPPED"
```

#### 8.3 暂停任务
```bash
curl -X PUT "http://localhost:8080/collect-task/46/status?status=PAUSED"
```

### 9. 数据库表结构

#### collect_task 表相关字段
```sql
CREATE TABLE collect_task (
  id bigint NOT NULL AUTO_INCREMENT,
  name varchar(100) NOT NULL,
  status varchar(20) DEFAULT 'PENDING' COMMENT '任务状态',
  start_time datetime COMMENT '开始时间',
  end_time datetime COMMENT '结束时间',
  create_time datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  update_time datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
);
```

#### test_case_execution_instance 表相关字段
```sql
CREATE TABLE test_case_execution_instance (
  id bigint NOT NULL AUTO_INCREMENT,
  collect_task_id bigint NOT NULL,
  test_case_id bigint NOT NULL,
  round int NOT NULL,
  status varchar(20) NOT NULL DEFAULT 'PENDING' COMMENT '执行状态',
  result varchar(20) COMMENT '执行结果',
  execution_task_id varchar(100),
  create_time datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  update_time datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
);
```

## 总结

任务状态更新功能提供了完整的状态管理机制，包括：
- ✅ 状态定义和验证
- ✅ 状态转换规则
- ✅ 联动更新机制
- ✅ 错误处理
- ✅ 日志记录
- ✅ 多种操作接口

这确保了任务状态的一致性和可靠性，同时提供了灵活的状态管理能力。
