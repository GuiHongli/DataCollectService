# 任务完成状态检查功能说明

## 概述

DataCollectService接收到用例执行结果后，会自动检查所有用例例次是否都已完成，如果全部完成则将采集任务状态置为完成，并更新结束时间和进度统计。

## 功能特性

### 1. 用例执行例次状态管理

#### 执行状态 (status)
- **PENDING**: 待执行
- **RUNNING**: 执行中
- **COMPLETED**: 已完成

#### 执行结果 (result)
- **SUCCESS**: 执行成功
- **FAILED**: 执行失败
- **BLOCKED**: 执行阻塞（如Python环境不可用）

### 2. 自动状态更新流程

#### 步骤1: 接收用例执行结果
```java
// TestCaseExecutionResultController.reportTestCaseResult()
@PostMapping("/report")
public Result<Map<String, Object>> reportTestCaseResult(@Valid @RequestBody TestCaseExecutionResult result)
```

#### 步骤2: 保存执行结果
```java
// TestCaseExecutionResultServiceImpl.saveTestCaseExecutionResult()
boolean success = save(entity);
```

#### 步骤3: 更新例次状态和结果
```java
// TestCaseExecutionResultServiceImpl.updateExecutionInstanceStatus()
String instanceStatus = "COMPLETED";  // 执行状态：已完成
String instanceResult = result.getStatus();  // 执行结果：SUCCESS/FAILED/BLOCKED

testCaseExecutionInstanceService.updateExecutionStatusAndResultByTestCaseAndRound(
    collectTaskId, result.getTestCaseId(), result.getRound(), instanceStatus, instanceResult);
```

#### 步骤4: 检查任务完成状态
```java
// TestCaseExecutionResultServiceImpl.checkAndUpdateTaskCompletion()
// 统计所有例次的状态
if (completedCount == totalCount) {
    // 所有例次都已完成，更新任务状态
    String finalStatus = "COMPLETED";
    if (failedCount > 0 || blockedCount > 0) {
        finalStatus = "FAILED";
    }
    
    collectTaskService.updateTaskStatus(collectTaskId, finalStatus);
    collectTaskService.updateTaskProgress(collectTaskId, totalCount, successCount, failedCount);
}
```

### 3. 数据库表结构

#### test_case_execution_instance 表
```sql
CREATE TABLE test_case_execution_instance (
  id bigint NOT NULL AUTO_INCREMENT,
  collect_task_id bigint NOT NULL,
  test_case_id bigint NOT NULL,
  round int NOT NULL,
  logic_environment_id bigint NOT NULL,
  executor_ip varchar(50) NOT NULL,
  status varchar(20) NOT NULL DEFAULT 'PENDING',  -- 执行状态
  result varchar(20),                              -- 执行结果
  execution_task_id varchar(100),
  create_time datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  update_time datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
);
```

#### collect_task 表
```sql
CREATE TABLE collect_task (
  id bigint NOT NULL AUTO_INCREMENT,
  name varchar(100) NOT NULL,
  status varchar(20) DEFAULT 'PENDING',           -- 任务状态
  total_test_case_count int DEFAULT 0,            -- 总用例数
  completed_test_case_count int DEFAULT 0,        -- 已完成用例数
  success_test_case_count int DEFAULT 0,          -- 成功用例数
  failed_test_case_count int DEFAULT 0,           -- 失败用例数
  start_time datetime,                            -- 开始时间
  end_time datetime,                              -- 结束时间
  create_time datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  update_time datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
);
```

## 状态流转图

```
用例执行例次状态流转：
PENDING → RUNNING → COMPLETED (SUCCESS/FAILED/BLOCKED)

采集任务状态流转：
PENDING → RUNNING → COMPLETED/FAILED
```

## 业务逻辑

### 1. 任务完成判断条件
- 所有用例执行例次的 `status` 都为 `COMPLETED`
- 至少有一个例次存在 `result` 值

### 2. 任务最终状态确定
- **COMPLETED**: 所有例次都成功执行 (`result = SUCCESS`)
- **FAILED**: 存在失败的例次 (`result = FAILED` 或 `result = BLOCKED`)

### 3. 进度统计
- **总用例数**: 所有用例执行例次的数量
- **已完成用例数**: `status = COMPLETED` 的例次数量
- **成功用例数**: `result = SUCCESS` 的例次数量
- **失败用例数**: `result = FAILED` 或 `result = BLOCKED` 的例次数量

## 测试验证

### 测试脚本
```bash
python test_task_completion.py
```

### 测试场景
1. **全部成功**: 所有用例执行成功，任务状态为 `COMPLETED`
2. **部分失败**: 部分用例执行失败，任务状态为 `FAILED`
3. **环境阻塞**: 部分用例因环境问题阻塞，任务状态为 `FAILED`
4. **混合结果**: 成功、失败、阻塞混合，任务状态为 `FAILED`

## 日志记录

### 关键日志点
1. **用例执行结果接收**: 记录接收到的执行结果详情
2. **例次状态更新**: 记录例次状态和结果的更新
3. **任务完成检查**: 记录任务完成状态的统计和判断
4. **任务状态更新**: 记录任务最终状态的更新

### 日志示例
```
INFO  - 接收到用例执行结果 - 任务ID: 1, 用例ID: 1, 轮次: 1, 状态: SUCCESS
INFO  - 用例执行结果保存成功 - 任务ID: 1, 用例ID: 1, 轮次: 1
DEBUG - 例次状态和结果更新成功 - 任务ID: 1, 用例ID: 1, 轮次: 1, 状态: COMPLETED, 结果: SUCCESS
DEBUG - 任务状态统计 - 任务ID: 1, 总数: 4, 已完成: 4, 成功: 3, 失败: 1, 阻塞: 0
INFO  - 所有用例例次已完成，更新任务状态为完成 - 任务ID: 1
INFO  - 任务状态更新成功 - 任务ID: 1, 最终状态: FAILED, 总数: 4, 成功: 3, 失败: 1
```

## 注意事项

1. **状态一致性**: 确保例次的 `status` 和 `result` 字段状态一致
2. **并发处理**: 多个用例同时上报结果时，需要正确处理并发更新
3. **异常处理**: 网络异常、数据库异常等需要妥善处理
4. **性能考虑**: 大量用例时，状态检查的性能优化
5. **数据完整性**: 确保任务完成时所有相关数据都已正确更新
