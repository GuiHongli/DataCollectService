# 采集任务失败原因功能说明

## 功能概述

采集任务失败原因功能用于记录和显示任务执行失败的具体原因，帮助用户快速定位问题并进行故障排查。

## 功能特性

### 1. 自动记录失败原因
- 任务执行失败时自动记录具体的失败原因
- 支持多种失败场景的错误信息记录
- 错误信息包含详细的异常描述

### 2. 前端展示
- 任务列表中显示失败原因（仅失败任务）
- 任务详情页面中突出显示失败原因
- 支持长文本的tooltip显示
- 错误信息使用醒目的红色样式

### 3. 后端支持
- 数据库字段：`failure_reason` (TEXT类型)
- API接口：`updateTaskFailureReason`
- 自动集成到任务执行流程中

## 技术实现

### 1. 数据库设计
```sql
-- 为采集任务表添加失败原因字段
ALTER TABLE `collect_task` 
ADD COLUMN `failure_reason` text COMMENT '失败原因（当任务状态为FAILED时记录）';

-- 为失败原因字段添加索引
ALTER TABLE `collect_task` ADD INDEX `idx_failure_reason` (`failure_reason`(100));
```

### 2. 后端实现

#### 实体类更新
```java
// CollectTask.java
@TableField("failure_reason")
private String failureReason;
```

#### 服务接口
```java
// CollectTaskService.java
boolean updateTaskFailureReason(Long id, String failureReason);
```

#### 服务实现
```java
// CollectTaskServiceImpl.java
@Override
public boolean updateTaskFailureReason(Long id, String failureReason) {
    UpdateWrapper<CollectTask> updateWrapper = new UpdateWrapper<>();
    updateWrapper.eq("id", id);
    updateWrapper.set("failure_reason", failureReason);
    updateWrapper.set("update_time", LocalDateTime.now());
    
    return update(updateWrapper);
}
```

#### 自动记录集成
```java
// CollectTaskProcessServiceImpl.java
// 在任务失败时自动记录失败原因
collectTaskService.updateTaskStatus(collectTaskId, "FAILED");
collectTaskService.updateTaskFailureReason(collectTaskId, "执行机服务调用失败");
```

### 3. 前端实现

#### 任务列表显示
```vue
<el-table-column prop="failureReason" label="失败原因" width="200">
  <template #default="scope">
    <div v-if="scope.row.status === 'FAILED' && scope.row.failureReason">
      <el-tooltip :content="scope.row.failureReason" placement="top" :show-after="500">
        <span class="failure-reason-text">{{ scope.row.failureReason }}</span>
      </el-tooltip>
    </div>
    <span v-else>-</span>
  </template>
</el-table-column>
```

#### 任务详情显示
```vue
<el-descriptions-item v-if="selectedTask.status === 'FAILED' && selectedTask.failureReason" label="失败原因">
  <el-alert
    :title="selectedTask.failureReason"
    type="error"
    :closable="false"
    show-icon
    style="margin: 0;"
  />
</el-descriptions-item>
```

#### 样式定义
```css
.failure-reason-text {
  color: #f56c6c;
  font-size: 12px;
  cursor: pointer;
  display: inline-block;
  max-width: 180px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
```

## 支持的失败原因类型

### 1. 执行机服务相关
- **执行机服务调用失败**: 执行机服务返回错误响应
- **执行机服务调用异常**: 网络连接异常或服务不可用
- **未找到可用的执行机IP**: 逻辑环境配置问题

### 2. 数据保存相关
- **保存用例执行例次失败**: 数据库操作失败
- **用例集文件不存在**: 文件路径或权限问题

### 3. 配置相关
- **逻辑环境列表为空**: 环境筛选条件过于严格
- **采集策略不存在**: 策略配置问题

### 4. 系统相关
- **内存不足**: 系统资源问题
- **磁盘空间不足**: 存储空间问题
- **权限不足**: 文件或网络访问权限问题

## 使用场景

### 1. 任务创建失败
当采集任务创建过程中出现异常时，系统会自动记录失败原因：
```java
try {
    // 任务创建逻辑
} catch (Exception e) {
    collectTaskService.updateTaskStatus(collectTaskId, "FAILED");
    collectTaskService.updateTaskFailureReason(collectTaskId, "任务创建失败: " + e.getMessage());
}
```

### 2. 执行机调用失败
当调用执行机服务失败时，记录具体的错误信息：
```java
if (!callSuccess) {
    collectTaskService.updateTaskStatus(collectTaskId, "FAILED");
    collectTaskService.updateTaskFailureReason(collectTaskId, "执行机服务调用失败");
}
```

### 3. 数据保存失败
当保存用例执行例次失败时：
```java
if (!saveSuccess) {
    throw new RuntimeException("保存用例执行例次失败");
}
```

## 用户界面

### 1. 任务列表页面
- 失败任务在"失败原因"列显示具体的错误信息
- 长文本自动截断，鼠标悬停显示完整内容
- 失败原因使用红色文字突出显示

### 2. 任务详情页面
- 失败任务在基本信息中显示失败原因
- 使用错误提示框样式，更加醒目
- 支持多行文本显示

### 3. 交互体验
- 鼠标悬停显示完整错误信息
- 错误信息可复制
- 响应式设计，适配不同屏幕尺寸

## 监控和日志

### 1. 日志记录
- 失败原因更新时记录详细日志
- 包含任务ID、失败原因、时间戳等信息
- 便于问题追踪和分析

### 2. 错误统计
- 可统计不同失败原因的出现频率
- 帮助识别系统瓶颈和常见问题
- 为系统优化提供数据支持

## 最佳实践

### 1. 错误信息编写
- 使用简洁明了的语言描述问题
- 包含关键的错误代码或标识
- 提供可能的解决方案建议

### 2. 用户指导
- 在错误信息中提供解决步骤
- 包含相关的配置检查点
- 提供技术支持联系方式

### 3. 系统监控
- 定期检查失败任务的失败原因
- 分析失败模式，优化系统配置
- 建立故障预警机制

## 总结

采集任务失败原因功能为系统提供了完善的错误追踪和用户反馈机制，大大提升了系统的可维护性和用户体验。通过自动记录、友好展示和详细分析，用户可以快速定位和解决问题，提高工作效率。
