# 业务流程关系图

## 概述

本文档描述了DataCollectService系统的核心业务流程，使用Mermaid流程图进行可视化展示。

## 主要业务流程

### 1. 采集任务创建流程

```mermaid
flowchart TD
    A[用户创建采集任务] --> B[选择采集策略]
    B --> C[配置地域筛选条件]
    C --> D[系统获取可用逻辑环境]
    D --> E[用户确认环境配置]
    E --> F[创建采集任务]
    F --> G[生成用例执行例次]
    G --> H[任务状态: PENDING]
    
    D --> D1[解析策略关联用例集]
    D1 --> D2[提取用例环境组网需求]
    D2 --> D3[根据地域筛选执行机]
    D3 --> D4[获取执行机关联逻辑环境]
    D4 --> D5[匹配环境组网与用例需求]
    D5 --> D6[返回可用逻辑环境列表]
```

### 2. 用例执行流程

```mermaid
flowchart TD
    A[采集任务启动] --> B[任务状态: RUNNING]
    B --> C[遍历用例执行例次]
    C --> D{例次状态?}
    D -->|PENDING| E[调用CaseExecuteService]
    D -->|RUNNING| F[等待执行完成]
    D -->|COMPLETED| G[跳过已完成的例次]
    
    E --> H[CaseExecuteService接收任务]
    H --> I[下载用例集文件]
    I --> J[解压文件到临时目录]
    J --> K[查找并执行Python脚本]
    K --> L[上报执行结果]
    L --> M[上报执行日志]
    M --> N[清理临时文件]
    
    L --> O[DataCollectService接收结果]
    O --> P[保存到test_case_execution_result表]
    P --> Q[更新test_case_execution_instance状态]
    Q --> R{所有例次完成?}
    R -->|否| C
    R -->|是| S[更新任务状态为COMPLETED]
```

### 3. 环境匹配流程

```mermaid
flowchart TD
    A[用户配置地域条件] --> B[获取地域层级关系]
    B --> C[查询符合条件的执行机]
    C --> D[获取执行机关联逻辑环境]
    D --> E[获取逻辑环境组网信息]
    E --> F[匹配用例环境需求]
    F --> G[返回可用逻辑环境列表]
    
    B --> B1[片区 → 国家 → 省份 → 城市]
    C --> C1[根据地域ID筛选执行机]
    D --> D1[查询logic_environment表]
    E --> E1[查询logic_environment_network表]
    F --> F1[比较logic_network与用例需求]
```

### 4. 数据流转关系

```mermaid
flowchart LR
    subgraph "配置层"
        A[Region<br/>地域表]
        B[Executor<br/>执行机表]
        C[LogicEnvironment<br/>逻辑环境表]
        D[LogicNetwork<br/>逻辑组网表]
    end
    
    subgraph "用例层"
        E[TestCaseSet<br/>用例集表]
        F[TestCase<br/>测试用例表]
    end
    
    subgraph "策略层"
        G[CollectStrategy<br/>采集策略表]
    end
    
    subgraph "任务层"
        H[CollectTask<br/>采集任务表]
        I[TestCaseExecutionInstance<br/>用例执行例次表]
    end
    
    subgraph "结果层"
        J[TestCaseExecutionResult<br/>用例执行结果表]
    end
    
    A --> B
    B --> C
    C --> D
    E --> F
    G --> H
    H --> I
    I --> J
    
    F -.->|环境需求匹配| D
    H -.->|地域筛选| A
    H -.->|策略关联| G
    G -.->|用例集关联| E
```

## 服务交互关系

### 1. 服务架构图

```mermaid
graph TB
    subgraph "前端层"
        A[DataCollectFront<br/>Vue.js前端]
    end
    
    subgraph "后端服务层"
        B[DataCollectService<br/>Spring Boot]
        C[CaseExecuteService<br/>Spring Boot]
    end
    
    subgraph "存储层"
        D[(MySQL数据库)]
        E[(GoHttpServer<br/>文件存储)]
    end
    
    subgraph "执行层"
        F[Python脚本<br/>测试用例]
    end
    
    A --> B
    B --> C
    B --> D
    C --> D
    C --> E
    C --> F
    
    B -.->|HTTP请求| C
    C -.->|文件下载| E
    C -.->|脚本执行| F
```

### 2. 接口调用关系

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant D as DataCollectService
    participant C as CaseExecuteService
    participant DB as 数据库
    participant G as GoHttpServer
    
    U->>F: 创建采集任务
    F->>D: POST /collect-task/create
    D->>DB: 保存任务信息
    D->>DB: 生成执行例次
    D->>C: POST /test-case-execution/receive
    C->>G: 下载用例集文件
    C->>C: 执行Python脚本
    C->>D: POST /test-result/report
    C->>D: POST /test-result/log/{filename}
    D->>DB: 保存执行结果
    D->>DB: 更新例次状态
    D->>F: 返回任务状态
    F->>U: 显示执行进度
```

## 状态流转图

### 1. 任务状态流转

```mermaid
stateDiagram-v2
    [*] --> PENDING: 创建任务
    PENDING --> RUNNING: 开始执行
    RUNNING --> COMPLETED: 所有例次完成
    RUNNING --> FAILED: 执行失败
    COMPLETED --> [*]
    FAILED --> [*]
```

### 2. 用例执行例次状态流转

```mermaid
stateDiagram-v2
    [*] --> PENDING: 生成例次
    PENDING --> RUNNING: 开始执行
    RUNNING --> COMPLETED: 执行成功
    RUNNING --> FAILED: 执行失败
    COMPLETED --> [*]
    FAILED --> [*]
```

### 3. 执行机状态流转

```mermaid
stateDiagram-v2
    [*] --> 在线: 注册执行机
    在线 --> 离线: 网络断开
    在线 --> 故障: 系统异常
    离线 --> 在线: 网络恢复
    故障 --> 在线: 故障修复
    离线 --> [*]: 删除执行机
    故障 --> [*]: 删除执行机
```

## 数据同步关系

### 1. 任务进度同步

```mermaid
flowchart TD
    A[用例执行完成] --> B[上报执行结果]
    B --> C[更新例次状态]
    C --> D[统计任务进度]
    D --> E[更新任务状态]
    E --> F[检查任务完成]
    F --> G{所有例次完成?}
    G -->|是| H[任务状态: COMPLETED]
    G -->|否| I[继续等待其他例次]
```

### 2. 环境资源同步

```mermaid
flowchart TD
    A[执行机状态变化] --> B[更新执行机状态]
    B --> C[影响逻辑环境可用性]
    C --> D[更新环境匹配结果]
    D --> E[影响新任务创建]
    
    F[地域信息变化] --> G[更新地域层级]
    G --> H[影响执行机筛选]
    H --> I[影响环境匹配]
```

## 错误处理流程

### 1. 执行失败处理

```mermaid
flowchart TD
    A[用例执行失败] --> B[记录失败原因]
    B --> C[更新例次状态为FAILED]
    C --> D[统计失败用例数]
    D --> E[更新任务失败统计]
    E --> F{是否影响任务完成?}
    F -->|是| G[任务状态: FAILED]
    F -->|否| H[继续执行其他用例]
```

### 2. 网络异常处理

```mermaid
flowchart TD
    A[网络连接异常] --> B[执行机状态: 离线]
    B --> C[标记关联环境不可用]
    C --> D[影响新任务分配]
    D --> E[等待网络恢复]
    E --> F[执行机状态: 在线]
    F --> G[恢复环境可用性]
```

## 性能优化策略

### 1. 数据库优化

- **索引优化**: 为常用查询字段建立索引
- **分页查询**: 大数据量查询使用分页
- **缓存策略**: 热点数据使用Redis缓存

### 2. 并发处理

- **异步执行**: 用例执行采用异步方式
- **线程池**: 使用线程池管理并发任务
- **队列机制**: 任务排队执行，避免资源竞争

### 3. 资源管理

- **连接池**: 数据库连接池管理
- **文件清理**: 及时清理临时文件
- **内存管理**: 合理控制内存使用
